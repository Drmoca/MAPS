library(expm)

makeQ <- function(M, q){
  Q = matrix(nrow=11, ncol=11, 0)
  Q[1,2] = 2*M[1,2]
  Q[1,3] = 2*M[1,3]
  Q[1,11] = q[1]
  Q[2,1] = M[2,1]
  Q[2,4] = M[2,4]
  Q[2,5] = M[1,2]
  Q[2,6] = M[1,3]
  Q[3,1] = M[3,1]
  Q[3,4] = M[3,4]
  Q[3,6] = M[1,2]
  Q[3,8] = M[1,3]
  Q[4,2] = M[4,2]
  Q[4,3] = M[4,3]
  Q[4,7] = M[1,2]
  Q[4,9] = M[1,3]
  Q[5,2] = 2*M[2,1]
  Q[5,7] = 2*M[2,4]
  Q[5,11] = q[2]
  Q[6,2] = M[3,1]
  Q[6,3] = M[2,1]
  Q[6,7] = M[3,4]
  Q[6,9] = M[2,4]
  Q[7,2] = 0
  Q[7,4] = M[2,1]
  Q[7,5] = M[4,2]
  Q[7,6] = M[4,3]
  Q[7,10] = M[2,4]
  Q[8,3] = 2*M[3,1]
  Q[8,9] = 2*M[3,4]
  Q[8,11] = q[3]
  Q[9,4] = M[3,1]
  Q[9,6] = M[4,2]
  Q[9,8] = M[4,3]
  Q[9,10] = M[3,4]
  Q[10,7] = 2*M[4,2]
  Q[10,9] = 2*M[4,3]
  Q[10,11] = q[4]

  diag(Q) = -rowSums(Q)
  return(Q)
}

computeWeights12 <- function(r, L){
  x = c(0.282858348239914111636, 0.952326041364613502533, 2.016492138577680732908, 3.49235406977802503696,
        5.40549102001572284444, 7.792813940412414977328, 10.70738868898909083941, 14.22715236378998067519,
        18.4719966342299991403, 23.64178375240089533211, 30.12005862610634429575, 38.88928437609531851144)
  w = c(0.101453765665592267304, 0.317699483362918101093, 0.3399862713744527945869, 0.1795325994391998189703,
        0.05203193903532839147698, 0.00849161743576890271165, 7.6713579727859799094E-4, 3.63620912038435440496E-5,
        8.18456700779946095612E-7, 7.323154100403232532E-9, 1.83970243442130592832E-11, 5.3776285222703704519E-15)
  w = w*(1/(L*2*r*L))
  x = x/(2*r*L)
  return(list(w=w, x=x))
}

computeWeights20 <- function(r, L){
  x = c(0.17490675238661462808, 0.58730308063826856398, 1.238225101834236254115, 2.13139626007693336644,
        3.27213313351698717505, 4.66749446588835560307, 6.3265361976738361974, 8.26067095201372850081,
        10.48416738120822849889, 13.01484877215262843371, 15.87508701278475484784, 19.09325190760625061433,
        22.70589388817313189969, 26.76117022937941365577, 31.32451613700752627862, 36.48870334614904728956,
        42.39342274577448784959, 49.26881384986848543417, 57.55442097131480409236, 68.37703781455228081652)
  w = c(0.043165637127123016042, 0.173393540003682950501, 0.2768639019724097882539, 0.256965148793469623307,
        0.1571958051558628616272, 0.0669008636195318320127, 0.0203012066844198449656, 0.0044331674291972079917,
        6.9623862451405933641E-4, 7.8005012015230761706E-5, 6.1411804007204543466E-6, 3.32160143764543229667E-7,
        1.19590145840090781978E-8, 2.74408893224395016621E-10, 3.7769340269412110656E-12, 2.8584518010325666186E-14,
        1.04277131616443520482E-16, 1.4763788135258949583E-19, 5.3790385783635671802E-23, 1.793160523059403199275E-27)
  
  w = w*(1/(L*2*r*L))
  x = x/(2*r*L)
  return(list(w=w, x=x))
}

computeWeights <- function(r, L){
  x = c(0.118440697736960550688, 0.3973475034735802657556, 0.8365549141880933313119, 1.437175158191620443607,
        2.200789508440616292336, 3.129448303166859096349, 4.225699164493802071261, 5.492626704368934083587,
        6.933903364122364597039, 8.553853192793023779194, 10.35753137020864105106, 12.35082332811269876439,
        14.54056869943518703492, 16.93471724415800802837, 19.54252664684054185266, 22.37481610233449499411,
        25.44429563058376261798, 28.76600031447167014762, 32.35787326932856805551, 36.24156497875364752439,
        40.44355691460364227197, 44.99678841355200250088, 49.94309754094208987181, 55.33704611950810443499,
        61.25224904369593075136, 67.79260716731075303985, 75.11420274687672563149, 83.47405073153149030595,
        93.36359463048878316735, 106.0462505962874034422)
  w = c(0.02093564741472521761, 0.09585049298017654367, 0.18833296435057945936, 0.23281944819987904471,
        0.2060782293528492151, 0.138528960450616358, 0.07293919110208096649, 0.030605607903988887905,
        0.010333948458420042431, 0.002821608083735993584, 6.2402663742264620427E-4, 1.1168849922460852198E-4,
        1.6129719270580565631E-5, 1.87044426274856472768E-6, 1.72995513372709914535E-7, 1.26506996496773906645E-8,
        7.2352574135703022224E-10, 3.19320138447436406004E-11, 1.069761647687436460972E-12, 2.66597906070505518515E-14,
        4.82019019925788439097E-16, 6.12740480626441608041E-18, 5.26125812567892365789E-20, 2.89562589607893296815E-22,
        9.51695437836864011982E-25, 1.69046847745875738033E-27, 1.39738002075239812243E-30, 4.20697826929603166432E-34,
        2.89826026866498969507E-38, 1.411587124593531584E-43)
  
  w = w*(1/(L*2*r*L))
  x = x/(2*r*L)
  return(list(w=w, x=x))
}

# the probability (density) that an IBD segment greater than u coalesces at time t
erlang <- function(u,t){
  return(exp(-2*u*t)*(1+2*u))
}
norm_vec <- function(x) sqrt(sum(x^2))

krylov <- function(Qrate, n, mkrylov, t){
  Q = matrix(nrow=n, ncol = mkrylov, 0)
  Q[n,1] = 1
  H = matrix(nrow=mkrylov, ncol=mkrylov, 0)
  for (k in 2:mkrylov){
    q = Q[,k-1]
    z = Qrate%*%q
    for (i in 1:k){
      H[i, k-1] = Q[,i]%*%z
      z = z - H[i,k-1]*Q[,i]
    }
    H[k, k-1] = norm_vec(z)
    if (H[k,k-1] == 0){
      break
    }
    Q[,k] = z/H[k, k-1]
  }
  E = expm(H*t)
  return(Q%*%E%*%t(Q)%*%Q[,1])
}

calculateIntegral <- function(r, L){
  ret = computeWeights(r, L)
  x = ret$x
  w = ret$w
  #P = matrix(0, nrow=length(x), ncol = 11)
  Pkrylov = matrix(0, nrow=length(x), ncol = 11)
  v = rep(0, 11)
  v[11] = 1
  for (i in 1:length(x)){
    #P[i,] = expm(Q*x[i])%*%v
    Pkrylov[i,] = krylov(Q, 11, 10, x[i])
  }
  
  #print(Pkrylov)
  
  #int = rep(0, 11)
  #for (i in 1:11){
  #  p = c(0, diff(P[,i])/(x[2:length(x)]-x[1:(length(x)-1)]))
  #  int[i] = w%*%p
  #}
  
  intkrylov = rep(0, 11)
  for (i in 1:11){
    pkrylov = c(0, diff(Pkrylov[,i])/(x[2:length(x)]-x[1:(length(x)-1)]))
    intkrylov[i] = w%*%pkrylov
  }
  
  print(intkrylov*3e9)
  
  ## Now try constant size 500 generations ago
  Ps = matrix(0, nrow=length(x), ncol = 11)
  temp = rep(0, 11)
  for (i in 1:length(x)){
    #P[i,] = expm(Q*x[i])%*%v
    if (x[i] < 350){
      Ps[i,] = krylov(Q, 11, 10, x[i])
    }
    else{
      #temp = rep(exp(-x[i]/10000)*(1/10000), 11)
      temp = rep(0, 11)
      temp[11] = 1
      Ps[i,] = temp
    }
  }
  print(sum(x< 350)/length(x))
  
  int = rep(0, 11)
  for (i in 1:11){
    p = c(0, diff(Ps[,i])/(x[2:length(x)]-x[1:(length(x)-1)]))
    int[i] = w%*%p
  }
  
  print(int*3e9)

  return(intkrylov*3e9)
}

q = c(7.82637e-8, 0.000000131538, 0.000155605,  0.00000000000045865)
#m = c(7.82637e-09, 0.000131538, 0.000755605,  0.00045865)
#M = matrix(nrow=4, ncol=4, 0)
#m = runif(4, min = 0, max = 0.01)
#M[1,2] = M[2,1] = (m[1]+m[2])/2
#M[1,3] = M[3,1] = (m[1]+m[3])/2
#M[2,4] = M[4,2] = (m[2]+m[4])/2
#M[3,4] = M[4,3] = (m[3]+m[4])/2
M = matrix(nrow = 4, ncol = 4, 0)
M[1,2] = M[2,1] = 0.00375863
M[1,3] = M[3,1] = 0.0289906 
M[2,4] = M[4,2] = 0.00448912
M[3,4] = M[4,3] = 0.00362955

Q = makeQ(M,q)
r = 1e-8
L = 2e6
int = calculateIntegral(r, L)
