library(expm)

computeWeights <- function(r, L){
  x = c(0.118440697736960550688, 0.3973475034735802657556, 0.8365549141880933313119, 1.437175158191620443607,
        2.200789508440616292336, 3.129448303166859096349, 4.225699164493802071261, 5.492626704368934083587,
        6.933903364122364597039, 8.553853192793023779194, 10.35753137020864105106, 12.35082332811269876439,
        14.54056869943518703492, 16.93471724415800802837, 19.54252664684054185266, 22.37481610233449499411,
        25.44429563058376261798, 28.76600031447167014762, 32.35787326932856805551, 36.24156497875364752439,
        40.44355691460364227197, 44.99678841355200250088, 49.94309754094208987181, 55.33704611950810443499,
        61.25224904369593075136, 67.79260716731075303985, 75.11420274687672563149, 83.47405073153149030595,
        93.36359463048878316735, 106.0462505962874034422)
  w = c(0.02093564741472521761, 0.09585049298017654367, 0.18833296435057945936, 0.23281944819987904471,
        0.2060782293528492151, 0.138528960450616358, 0.07293919110208096649, 0.030605607903988887905,
        0.010333948458420042431, 0.002821608083735993584, 6.2402663742264620427E-4, 1.1168849922460852198E-4,
        1.6129719270580565631E-5, 1.87044426274856472768E-6, 1.72995513372709914535E-7, 1.26506996496773906645E-8,
        7.2352574135703022224E-10, 3.19320138447436406004E-11, 1.069761647687436460972E-12, 2.66597906070505518515E-14,
        4.82019019925788439097E-16, 6.12740480626441608041E-18, 5.26125812567892365789E-20, 2.89562589607893296815E-22,
        9.51695437836864011982E-25, 1.69046847745875738033E-27, 1.39738002075239812243E-30, 4.20697826929603166432E-34,
        2.89826026866498969507E-38, 1.411587124593531584E-43)
  
  w = w*(1/(L*2*r*L))
  x = x/(2*r*L)
  return(list(w=w, x=x))
}

computeWeights50 <- function(r, L){
  x = c()
  w = c()
  w = w*(1/(L*2*r*L))
  x = x/(2*r*L)
  return(list(w=w, x=x))
}

# the probability (density) that an IBD segment greater than u coalesces at time t
erlang <- function(u,t){
  return(exp(-2*u*t)*(1+2*u))
}
norm_vec <- function(x) sqrt(sum(x^2))


calculateIntegral <- function(M, q, r, L){
  ret = computeWeights(r, L)
  x = ret$x
  w = ret$w
  d = nrow(M)
  p = array(0, dim = c(d, d, length(x)))
  lambda = matrix(0, nrow = d, ncol = d, 0)
  for (t in 1:length(x)){
    Pm = expm(M*x[t])
    for (i in 1:d){
      for (j in i:d){
        #p[i,j, t] = sum(Pm[i,]*Pm[j,]*q)
        lambda[i,j] = lambda[i,j] + w[t]*sum(Pm[i,]*Pm[j,]*q)
      }
    }
  }

  #for (i in 1:d){
  #  for (j in 1:d){
  #    lambda[i,j] = w%*%p[i,j,]
  #  }
  #}
  
  print(3e9*lambda)
}
#N = c(10000, 10000)
#q = 1/(2*N)
q = c(0.00005, 0.00005, 0.00005, 0.00005)
#m = c(7.82637e-09, 0.000131538, 0.000755605,  0.00045865)
#M = matrix(nrow=4, ncol=4, 0)
#m = runif(4, min = 0, max = 0.01)
#M[1,2] = M[2,1] = (m[1]+m[2])/2
#M[1,3] = M[3,1] = (m[1]+m[3])/2
#M[2,4] = M[4,2] = (m[2]+m[4])/2
#M[3,4] = M[4,3] = (m[3]+m[4])/2
M = matrix(nrow = 4, ncol = 4, 0)
M[1,2] = M[2,1] = 0.099962
M[1,3] = M[3,1] = 0.099962 
M[2,3] = M[3,2] = 0.099962
M[2,4] = M[4,2] = 0.099962
M[3,4] = M[4,3] = 0.099962
diag(M) = -rowSums(M)

r = 1e-8
L = 4e6
constantsize_m = (2*2*N*r)/(1+2*2*N*L*r)^2
int = calculateIntegral(M, q, r, L)
